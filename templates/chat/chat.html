{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.username }} - ChatApp{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="chat-wrapper glass-card">
        <!-- Chat Header -->
        <div class="chat-header">
            <a href="{% url 'chat:user_list' %}" class="btn-back" title="Back to chats">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="chat-header-user">
                <div class="user-avatar-wrapper">
                    <div class="user-avatar">
                        {{ other_user.username|first|upper }}
                    </div>
                    <span class="status-dot {% if other_user.is_online %}online{% else %}offline{% endif %}"
                        id="user-status-dot">
                    </span>
                </div>
                <div class="chat-header-info">
                    <h2 class="chat-username">{{ other_user.username }}</h2>
                    <span class="chat-status" id="chat-status">
                        {% if other_user.is_online %}
                        Online
                        {% else %}
                        Last seen {{ other_user.last_seen|timesince }} ago
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="chat-messages" id="chat-messages">
            {% for msg in messages %}
            <div class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}"
                id="msg-{{ msg.id }}" data-message-id="{{ msg.id }}">
                <div class="message-bubble">
                    <p class="message-text">{{ msg.content }}</p>
                    <div class="message-meta">
                        <span class="message-time">{{ msg.timestamp|date:"M d, Y h:i A" }}</span>
                        {% if msg.sender == request.user %}
                        <span class="read-receipt" data-msg-id="{{ msg.id }}">
                            {% if msg.is_read %}
                            <span class="read" title="Read">✓✓</span>
                            {% else %}
                            <span class="sent" title="Sent">✓</span>
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% if msg.sender == request.user %}
                <button class="btn-delete-msg" onclick="deleteMessage({{ msg.id }})" title="Delete message">
                    <i class="bi bi-trash3"></i>
                </button>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-chat" id="empty-chat">
                <i class="bi bi-chat-heart"></i>
                <h3>Start a conversation</h3>
                <p>Send your first message to {{ other_user.username }}!</p>
            </div>
            {% endfor %}
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <span class="typing-text" id="typing-text">{{ other_user.username }} is typing...</span>
        </div>

        <!-- Message Input Area -->
        <div class="chat-input-area">
            <form id="chat-form" class="chat-form" onsubmit="return false;">
                <div class="input-wrapper">
                    <input type="text" id="message-input" class="form-control message-input"
                        placeholder="Type a message..." autocomplete="off" maxlength="5000">
                    <button type="submit" class="btn btn-send" id="send-btn" title="Send message">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================
    // Configuration & State
    // ============================
    const currentUserId = {{ current_user_id }};
    const otherUserId = {{ other_user.id }};
    const otherUsername = "{{ other_user.username }}";
    const roomName = "{{ room_name }}";

    let chatSocket = null;
    let typingTimeout = null;
    let isTyping = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // ============================
    // DOM References
    // ============================
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const chatForm = document.getElementById('chat-form');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');
    const chatStatus = document.getElementById('chat-status');
    const statusDot = document.getElementById('user-status-dot');

    // ============================
    // WebSocket Connection
    // ============================
    function connectWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${wsScheme}://${window.location.host}/ws/chat/${roomName}/`;

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function () {
            console.log('WebSocket connected');
            reconnectAttempts = 0;

            // Mark messages as read when chat is opened
            chatSocket.send(JSON.stringify({
                'type': 'mark_read',
                'sender_id': otherUserId,
            }));
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };

        chatSocket.onclose = function (e) {
            console.log('WebSocket disconnected', e.code);
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts})`);
                setTimeout(connectWebSocket, delay);
            }
        };

        chatSocket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };
    }

    // ============================
    // Message Handlers
    // ============================
    function handleWebSocketMessage(data) {
        switch (data.type) {
            case 'chat_message':
                handleChatMessage(data);
                break;
            case 'typing':
                handleTypingIndicator(data);
                break;
            case 'messages_read':
                handleMessagesRead(data);
                break;
            case 'user_status':
                handleUserStatus(data);
                break;
            case 'message_deleted':
                handleMessageDeleted(data);
                break;
        }
    }

    function handleChatMessage(data) {
        // Remove empty chat placeholder
        const emptyChat = document.getElementById('empty-chat');
        if (emptyChat) emptyChat.remove();

        const isSent = data.sender_id === currentUserId;
        const messageHtml = createMessageElement(data, isSent);
        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        scrollToBottom();

        // If received a message, mark it as read
        if (!isSent) {
            chatSocket.send(JSON.stringify({
                'type': 'mark_read',
                'sender_id': otherUserId,
            }));
        }

        // Hide typing indicator
        typingIndicator.style.display = 'none';
    }

    function createMessageElement(data, isSent) {
        const deleteBtn = isSent ?
            `<button class="btn-delete-msg" onclick="deleteMessage(${data.message_id})" title="Delete message">
                <i class="bi bi-trash3"></i>
            </button>` : '';

        const readReceipt = isSent ?
            `<span class="read-receipt" data-msg-id="${data.message_id}">
                <span class="sent" title="Sent">✓</span>
            </span>` : '';

        return `
            <div class="message ${isSent ? 'sent' : 'received'} message-animate"
                 id="msg-${data.message_id}" data-message-id="${data.message_id}">
                <div class="message-bubble">
                    <p class="message-text">${escapeHtml(data.message)}</p>
                    <div class="message-meta">
                        <span class="message-time">${data.timestamp}</span>
                        ${readReceipt}
                    </div>
                </div>
                ${deleteBtn}
            </div>
        `;
    }

    function handleTypingIndicator(data) {
        if (data.user_id === otherUserId) {
            if (data.is_typing) {
                typingIndicator.style.display = 'flex';
                typingText.textContent = `${data.username} is typing...`;
                scrollToBottom();
            } else {
                typingIndicator.style.display = 'none';
            }
        }
    }

    function handleMessagesRead(data) {
        if (data.sender_id === currentUserId) {
            // All my messages have been read by the other person
            document.querySelectorAll('.read-receipt').forEach(el => {
                el.innerHTML = '<span class="read" title="Read">✓✓</span>';
            });
        }
    }

    function handleUserStatus(data) {
        if (data.user_id === otherUserId) {
            if (data.is_online) {
                statusDot.classList.remove('offline');
                statusDot.classList.add('online');
                chatStatus.textContent = 'Online';
                chatStatus.classList.add('status-online');
            } else {
                statusDot.classList.remove('online');
                statusDot.classList.add('offline');
                chatStatus.textContent = 'Offline';
                chatStatus.classList.remove('status-online');
            }
        }
    }

    function handleMessageDeleted(data) {
        const msgEl = document.getElementById(`msg-${data.message_id}`);
        if (msgEl) {
            msgEl.classList.add('message-fade-out');
            setTimeout(() => msgEl.remove(), 300);
        }
    }

    // ============================
    // Send Message
    // ============================
    function sendMessage() {
        const message = messageInput.value.trim();

        // Prevent empty messages
        if (!message) return;
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;

        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message,
            'receiver_id': otherUserId,
        }));

        messageInput.value = '';
        messageInput.focus();

        // Stop typing indicator
        if (isTyping) {
            chatSocket.send(JSON.stringify({
                'type': 'typing',
                'is_typing': false,
            }));
            isTyping = false;
        }
    }

    // ============================
    // Delete Message
    // ============================
    function deleteMessage(messageId) {
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;

        if (confirm('Delete this message?')) {
            chatSocket.send(JSON.stringify({
                'type': 'delete_message',
                'message_id': messageId,
            }));
        }
    }

    // ============================
    // Typing Indicator
    // ============================
    function handleTyping() {
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;

        if (!isTyping) {
            isTyping = true;
            chatSocket.send(JSON.stringify({
                'type': 'typing',
                'is_typing': true,
            }));
        }

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            isTyping = false;
            chatSocket.send(JSON.stringify({
                'type': 'typing',
                'is_typing': false,
            }));
        }, 2000);
    }

    // ============================
    // Utilities
    // ============================
    function scrollToBottom() {
        requestAnimationFrame(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============================
    // Event Listeners
    // ============================
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        sendMessage();
    });

    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    messageInput.addEventListener('input', handleTyping);

    // Focus on input when page loads
    messageInput.focus();

    // Auto-scroll on page load
    scrollToBottom();

    // Connect WebSocket
    connectWebSocket();

    // Handle page unload
    window.addEventListener('beforeunload', function () {
        if (chatSocket) {
            chatSocket.close();
        }
    });
</script>
{% endblock %}